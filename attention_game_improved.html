<!DOCTYPE html>
<html lang="zh-Hant">
<meta charset="UTF-8">
<title>持續專注力測試‧可自訂切換間隔</title>
<style>
  body{margin:0;font-family:sans-serif;background:#f0f8ff;text-align:center}
  canvas{display:block;margin:0 auto;background:#f0f8ff}
  button{width:160px;height:48px;margin:8px;border:0;border-radius:8px;background:#b0c4de;color:#fff;font-size:18px;cursor:pointer}
  button:hover{background:#778899}
</style>

<canvas id="game" width="800" height="480"></canvas>
<div>
  <span id="score">分數: 0</span>&emsp;<span id="timer">時間: 03:00</span><br><br>
  <!-- A / S / D 對應三顆按鈕，順序：數字相同、兩者皆相同、Icon 相同 -->
  <button data-type="digit">A：數字相同</button>
  <button data-type="both">S：兩者皆相同</button>
  <button data-type="icon">D：顏色相同</button>
</div>

<script>
/***** 參數設定 *****/
const ICON_SIZE       = 160;    // 圖示尺寸
const GAME_DURATION   = 300;    // 遊戲秒數
const SWITCH_INTERVAL = 3000;   // 題目顯示時間（毫秒）
const FLASH_MS        = 300;    // 題目切換時閃光持續時間（毫秒）
const FLASH_COLOR     = '#fffacd'; // 淡黃色，較白色更醒目
const SCALE_MS        = 250;    // 放大縮小動畫時間
const SCALE_FACTOR    = 1.3;    // 初始放大倍率

/***** 畫布 & 基本變數 *****/
const canvas = document.getElementById('game');
const ctx    = canvas.getContext('2d');
let score = 0,
    startTime = Date.now(),
    lastSwitch = Date.now(),
    flashUntil = 0,
    scaleUntil = 0,
    playerAnswered = false;

/***** AudioContext & 簡易提示音 *****/
let audioCtx;
function playBeep(){
  if(!audioCtx) return; // 尚未解鎖 AudioContext
  const osc  = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'square';
  osc.frequency.value = 880;
  gain.gain.value = 0.25;
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.15);
}
function unlockAudio(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    audioCtx.resume();
  }
  window.removeEventListener('keydown', unlockAudio, {capture:true});
  window.removeEventListener('mousedown', unlockAudio, {capture:true});
}
window.addEventListener('keydown', unlockAudio, {capture:true});
window.addEventListener('mousedown', unlockAudio, {capture:true});

/***** 動態產生 5 個彩色方塊作為圖示 *****/
const icons = {},
      colors = ['#ff5252', '#4caf50', '#2196f3', '#ffeb3b', '#e040fb'];
colors.forEach((c, i) => {
  const buf = document.createElement('canvas');
  buf.width = buf.height = ICON_SIZE;
  const bctx = buf.getContext('2d');
  bctx.fillStyle = c;
  bctx.fillRect(0, 0, ICON_SIZE, ICON_SIZE);
  bctx.fillStyle = 'rgba(255,255,255,.2)';
  bctx.font = 'bold 42px sans-serif';
  bctx.textAlign = 'center';
  bctx.textBaseline = 'middle';
  bctx.fillText(String.fromCharCode(65 + i), ICON_SIZE / 2, ICON_SIZE / 2);
  icons['icon' + i] = buf;
});
const iconNames = Object.keys(icons);

/***** 遊戲邏輯 *****/
let currentDigit, currentIcon, prevDigit, prevIcon;
function newStimulus(){
  prevDigit = currentDigit; prevIcon = currentIcon;
  currentDigit = Math.random() < .2 && prevDigit !== undefined ? prevDigit : 1 + Math.floor(Math.random() * 9);
  currentIcon = Math.random() < .2 && prevIcon  !== undefined ? prevIcon : iconNames[Math.random() * iconNames.length | 0];
  // 閃光 & 動畫 & 音效
  flashUntil = Date.now() + FLASH_MS;
  scaleUntil = Date.now() + SCALE_MS;
  playBeep();
}
function check(type){
  if(playerAnswered) return;
  const dSame = currentDigit === prevDigit && prevDigit !== undefined;
  const iSame = currentIcon === prevIcon && prevIcon !== undefined;
  const needAnswer = dSame || iSame; // 是否需要作答
  let correct = false;
  if(type === 'digit' && dSame && !iSame)       correct = true;
  else if(type === 'icon' && iSame && !dSame)   correct = true;
  else if(type === 'both' && dSame && iSame)    correct = true;
  else if(!needAnswer && type === undefined)    correct = true; // 不該作答且沒按鍵

  if(needAnswer){
      score += correct ? 1 : -1;
  }else{
      if(type !== undefined) score -= 1; // 誤按扣分
  }
  document.getElementById('score').textContent = `分數: ${score}`;
  playerAnswered = true;
}

/***** 主迴圈 *****/
function loop(){
  const now = Date.now();
  const elapsed = (now - startTime) / 1000;
  const remain  = Math.max(0, GAME_DURATION - elapsed);
  document.getElementById('timer').textContent = `時間: ${String(Math.floor(remain / 60)).padStart(2,'0')}:${String(Math.floor(remain % 60)).padStart(2,'0')}`;

  // 題目切換
  if(now - lastSwitch >= SWITCH_INTERVAL){
      const needAnswer = (currentDigit === prevDigit && prevDigit !== undefined) || (currentIcon === prevIcon && prevIcon !== undefined);
      if(needAnswer && !playerAnswered){ // 應作答未作答扣分
          score--; document.getElementById('score').textContent = `分數: ${score}`;
      }
      playerAnswered = false;
      newStimulus();
      lastSwitch = now;
  }

  // 畫面刷新
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // 閃光背景
  if(now < flashUntil){
      ctx.fillStyle = FLASH_COLOR;
      ctx.fillRect(0,0,canvas.width,canvas.height);
  }
  // 計算縮放
  let scale = 1;
  if(now < scaleUntil){
      const p = 1 - (scaleUntil - now) / SCALE_MS; // 0→1
      scale = SCALE_FACTOR - (SCALE_FACTOR - 1) * p; // 從 SCALE_FACTOR 緩回 1
  }
  // 畫數字
  if(currentDigit !== undefined){
      ctx.save();
      ctx.translate(canvas.width / 4, canvas.height / 2);
      ctx.scale(scale, scale);
      ctx.fillStyle = '#2f4f4f';
      ctx.font = `${160}px sans-serif`;
      ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
      ctx.fillText(currentDigit, 0, 0);
      ctx.restore();
  }
  // 畫 icon
  const img = icons[currentIcon];
  if(img){
      ctx.save();
      ctx.translate(canvas.width * 0.65, canvas.height / 2 - ICON_SIZE / 2 * scale);
      ctx.scale(scale, scale);
      ctx.drawImage(img, -ICON_SIZE/2, 0, ICON_SIZE, ICON_SIZE);
      ctx.restore();
  }

  if(remain > 0) requestAnimationFrame(loop); else alert(`遊戲結束！你的分數：${score}`);
}

/***** 事件繫結 *****/
document.querySelectorAll('button').forEach(b => {
  b.onclick = () => check(b.dataset.type);
});
window.addEventListener('keydown', e => {
  if(e.repeat) return;
  const key = e.key.toLowerCase();
  if(key === 'a')      check('digit');
  else if(key === 's') check('both');
  else if(key === 'd') check('icon');
});

/***** 開始遊戲 *****/
newStimulus();
loop();
</script>
</html>
